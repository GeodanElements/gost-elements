<link rel="import" href="../polymer/polymer.html">
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
<!--
<link rel="import" href="../mqtt-elements/mqtt-connection.html">
<link rel="import" href="../mqtt-elements/mqtt-subscription.html">
-->

<dom-module id="gost-mqtt">
    <template>
		<!--
    <mqtt-connection
        id="connection"
        url="[[url]]"
        connected="{{connected}}"
        client="{{client}}"
        subscriptions="{{subscriptions}}"
        options='{{options}}'
        on-mqtt-message='onMessageArrived'
		on-mqtt-connection-close='onConnectionLost'
		on-mqtt-connection-error='onConnectionError'>
    </mqtt-connection>
	-->
    </template>


<script>

	 class GostMqtt extends Polymer.Element {
		static get is() {return 'gost-mqtt'}
		static get properties() {return {
			url: {
				type: String,
				value: 'gost.geodan.nl'
			},
			client: {
				type: Object,
				notify: true
			},
			connected: {
				notify: true
			}
		}}
		static get observers(){return [
			
		]}
		ready(){
			//Got this from https://github.com/gost/dashboard/blob/master/content/js/app.js
			function guid() {
				function s4() {
					return Math.floor((1 + Math.random()) * 0x10000)
					.toString(16)
					.substring(1);
				}
				return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
					s4() + '-' + s4() + s4() + s4();
			}
			function onConnect() {
				console.log('Yeah, connected');
				self.client.subscribe("Datastreams(1)/Observations");
			}
			super.ready();
			var self = this;
			this.client = new Paho.MQTT.Client(this.url, Number(9001), guid());
			this.client.onConnectionLost = this.onConnectionLost;
			this.client.onMessageArrived = this.onMessageArrived;
			this.client.connect({ onSuccess: onConnect });
		}
		
		onMessageArrived(message) {
			if(message && message.destinationName) {
				var data = {
					topic: message.destinationName,
					message: JSON.parse(message.payloadString)
				  };
				this.fire('message',data);
			}
			/* 
			switch (message.topic) {
				case '$SYS/broker/version':
					self.brokerVersion = message.payloadString;
					break;
				case '$SYS/broker/timestamp':
					self.brokerTimestamp = message.payloadString;
					break;
				case '$SYS/broker/uptime':
					self.brokerUptime = message.payloadString;
					break;
				case '$SYS/broker/subscriptions/count':
					self.brokerSubscriptions = message.payloadString;
					break;
				case '$SYS/broker/clients/connected':
					self.clientsConnected = message.payloadString;
					break;
				case '$SYS/broker/clients/disconnected':
					self.clientsDisconnected = message.payloadString;
					break;
				case '$SYS/broker/clients/expired':
					self.clientsExpired = message.payloadString;
					break;
				case '$SYS/broker/messages/sent':
					self.messagesSent = message.payloadString;
					break;
				case '$SYS/broker/messages/received':
					self.messagesReceived = message.payloadString;
					break;
				case '$SYS/broker/messages/stored':
					self.messagesStored = message.payloadString;
					break;
				case '$SYS/broker/bytes/sent':
					self.trafficSent = message.payloadString;
					break;
				case '$SYS/broker/bytes/received':
					self.trafficReceived = message.payloadString;
					break;
			}
			*/
	 	}
		onConnectionLost(e,msg){
			console.log(e);
		}
		onConnectionError(e){
			console.log(e);
		}
	};
	window.customElements.define(GostMqtt.is, GostMqtt);
</script>
</dom-module>